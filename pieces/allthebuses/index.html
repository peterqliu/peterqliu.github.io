
<html>
<head>
    <meta charset='utf-8' />
    <title>allthebuses</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.6.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.54.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/94/three.min.js'></script>
<script src="https://unpkg.com/three@0.106.2/examples/js/loaders/GLTFLoader.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,300' rel='stylesheet' type='text/css'>


<!--     <script src='munirouteconfig.js'></script>
 -->    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,300' rel='stylesheet' type='text/css'>
    <style>
        body { margin:0; padding:0; font-family: 'Open Sans', Verdana, sans-serif;}
        #map, #overlay { position:absolute; top:0; bottom:0; width:100%; }
        #controls { position:absolute; top:0; left:0; }
        canvas {
            cursor:auto;
        }
        .mapboxgl-map {
            font-family: inherit
        }

        .mapboxgl-popup-content {
            padding:20px;
            font-size:1.25em;
            border-radius: 5px;   
            color:#999;
            box-shadow: 0 2px 8px rgba(186, 180, 157, 1)
        }

        .title {
            font-weight:100;
            font-size:1.5em;
            color:#666;
            line-height: 1.5em;
        }

        .IB .highlight {
            color: rgba(170, 51, 69, 1);
        }        

        .OB .highlight {
            color: rgba(65, 166, 178, 1);
        }
    </style>
    <script>

        var s = {
            mode: 'inactive',
            center: [-122.437, 37.782],
            activeRoute: false,
            routeDrawStart: Date.now(),
            utils: {
                degreeify: radians =>{
                    radians = radians || 0;
                    return radians * 360/(Math.PI*2)
                },

                radify: deg => 2*Math.PI * deg/360
            },
            highlightedBus: {
                uuid: null, 
                routeId: null,
                startTime: null,
                markerObj: null
            },
            map: {
                popup: new mapboxgl.Popup({ 
                    closeButton: false, 
                    offset:25, 
                    maxWidth:'none' 
                })
                    // .setLngLat([-96, 37.8])
                    // .setHTML('<h1>Hello World!</h1>')
                    // .addTo(map);
            }
        }

        var c = {
            animationDuration: 500,
            markerScale: 0.000002,
            emptyGeojson: turf.featureCollection([]),
            color: {
                'IB':'rgba(170, 51, 69, 1)',
                'OB': 'rgba(65, 166, 178, 1)',
                'weak':'#BAB49D'
            },
            routeData:{

            }
        }

        c.style = {
            focus:[
                ['route', 'line-width', {stops:[[12,1], [22,20]]}],
                ['stops', 'circle-stroke-width', {stops:[[12,1], [22,20]]}],
                ['stops', 'circle-radius', {stops:[[12,1], [22,20]]}],
                // ['buses', 'circle-color', c.color.weak],
                ['bus_labels', 'text-opacity', 1]
            ],
            active:[
                ['route', 'line-width', {stops:[[12,1], [22,20]]}],
                ['stops', 'circle-stroke-width', {stops:[[12, 1], [22,20]]}],
                ['stops', 'circle-radius', 0],
                // ['buses', 'circle-color', c.color.weak],
                ['bus_labels', 'text-opacity', 0]
            ],
            inactive:[
                ['route', 'line-width', 0],
                ['stops', 'circle-stroke-width', 0],
                ['stops', 'circle-radius', 0],
                ['buses', 'circle-color', {
                    'property': 'direction',
                    'type':'categorical',
                    'stops':[['IB', c.color.IB], ['OB', c.color.OB]]
                }],
                ['bus_labels', 'text-opacity', 0]
            ]
        }

        const app = {
            getPrediction: (route, stop, cb) => {
                const url = `http://restbus.info/api/agencies/sf-muni/routes/${route}/stops/${stop}/predictions`;

                d3.json(url, (e,r)=>{
                    if (e) return
                    cb(r[0].values[0]);
                })

            }
        }
        function setState(key, value){

            if (key === 'activeRoute'){

                var newRoute = value ? [value.routeId,value.direction,value.directionId] : false

                //if already highlighting
                if (s.activeRoute){

                    if (newRoute){
                        if (newRoute !== s.activeRoute) s.activeRoute = newRoute
                    }

                    else s.activeRoute = newRoute
                }

                //if no previous highlight
                else if (newRoute) s.activeRoute = newRoute

                
                // if no new highlight
                else {
                    
                }

                updateRoute();
            }

            else if (key === 'mode') {

                s.mode = value;
                c.style[value].forEach(function(style){
                    map.setPaintProperty(style[0], style[1], style[2])
                })

                if (value === 'inactive') {

                }
            }
        }
    </script>


    <body>
        <canvas id='overlay' style='z-index: 99; height:100%; pointer-events: none'></canvas>
        <div id='map'></div>
    </body>
    <script src='map.js'></script>
    <script src='customlayer.js'></script>

    <!-- <script src='3.js'></script> -->
</head>

</html>