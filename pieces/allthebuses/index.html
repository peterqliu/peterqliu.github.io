
<html>
<head>
    <meta charset='utf-8' />
    <title>allthebuses</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/94/three.min.js'></script>
    <link href="https://api.mapbox.com/mapbox-assembly/v1.5.1/assembly.min.css" rel="stylesheet">

    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.6.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="src/style.css">
    <body mode='loading'>
        <div id='loader' class='blurred'>
            <div id='spinner' ></div>
        </div>
        <div id='map'>
            <div id='modal' class="mr18 mb18">
                <div id='general' class="flex flex--column" style="max-height: 96vh;">
                    <div class="px30 py30">
                        <div class='title'>Muni, this moment</div>
                        <div class='bar' style="background: var(--OB)">
                            <div id="inboundBar" class="fr"></div>
                        </div>
                        <div class='modalSmall'>
                            <span class='left ob marker'></span>
                            <span id='ob'></span> Outbound
                            <span class="fr">
                                <span id='ib'></span> 
                                Inbound 
                                <span class='right ib marker' 
                                    style=' margin-right:2px'
                                ></span>
                            </span>
                        </div>
                    </div>
                    <div class="grid  border-b border--gray-light cursor-pointer">
                        <div class="tab w-1/3 align-center subtitle pb12 opacity25">Vehicles</div>
                        <div class="tab w-1/3 align-center subtitle pb12 opacity25">System</div>
                        <div class="tab w-1/3 align-center subtitle pb12">24h Trends</div>
                    </div>

                    <div class="flex-child-grow overflow-scroll">
                        <div id='' class="tabView" style="display:none"></div>    
                        <div id='routeList' class="tabView" style="display:none"></div>    
                        <div class="tabView" id="trend" style="display:non">
                            <div class="listEntry px30">

                                <!-- UTILIZATION -->
                                <span class="subtitle">Utilization</span>
                                <!-- <span class="fr modalSmall txt-underline utilization percentToggle">Show percentage</span> -->
                                <div class="modalSmall"><span class="OB highlight">Ridership (estimated)</span> / <span class="IB highlight">total capacity</span> = <span class="dashedUnderline">usage ratio (%)</span></div>
                                <div class="relative mt12" id="utilization">

                                </div>

                                <div class="modalSmall mt18">Fluctuations in <span class="IB highlight">capacity</span> and <span class="OB highlight">ridership</span> (10-minute increments)</div>
                                <div class="relative mt18" id="utilizationFlux">
                                </div>
                            </div>
                            <div class="listEntry px30">
                                <div class="subtitle">Rider distribution</div>
                                <div class="modalSmall">Click to inspect route distribution at that time</div>

                                <div class="relative mt12" id="blend">
                                    <div class="modalSmall align-t inline-block" id="yLabel"></div>
                                    <div class="inline-block">
                                        <div class="relative hoverChildVisible">
                                            <div class="events-none absolute modalSmall z5 graphNotation none bottom left bg-lighten75 pr12">
                                                <div id="date"></div>
                                            </div>
                                            <div class="absolute h-full hoverLine none events-none"></div>
                                            <div class="absolute midnight h-full z-neg1" style='border-left:2px dotted #ddd'></div>
                                            <svg class="graph align-t" preserveAspectRatio="xMinYMin meet">
                                                <!-- <g></g> -->
                                            </svg>
                                        </div>
                                        <div class="xaxis modalSmall relative">
                                            <span class="yesterday inline-block fl absolute"></span>
                                            <span class="midnight inline-block opacity25" style="filter:brightness(0)">ðŸŒ™</span>
                                            <span class="today inline-block fr"></span>
                                        </div>
                                    </div>
                                </div>
                                <div id="blendAtTime" class="non relative">
                                    <div class="modalSmall mt12">Rider distribution at this time (scanning vertically, of above cross-section)</div>
                                    <div id="blendBar" class="mt12 h24 round"></div>
                                </div>

                            </div>
                            <div class="listEntry">
                                <div class="subtitle">People flow</div>
                            </div>
                            <div class="listEntry">
                                <div class="subtitle">Vehicle occupancy</div>
                            </div>
                        </div>
                    </div>
   
                </div>
         
                <div id='routeFocus' class="flex flex--column" style="max-height: 96vh">
                    <div class='px30 py30  border-b border--gray-lighter'>
                        <div class='title wmax360' id="routeName"></div>
                        <div class='subtitle'>
                            <span id="directionText" class="directionText highlight"></span> to
                            <span id="routeDir"></span>
                        </div>
                    </div>
                    <div class="routeView overflow-scroll relative">
                        <div id="routeStops" class="relative">
                            <span id="routeTrack" class="absolute round z5 block"></span>
                        </div>
                        <div id="routeBuses"></div>    
                    </div>
                </div>

            </div>            
        </div>

        <img src='src/zoomout.svg'id='back' class="mt12 ml12 opacity75" onclick='app.setState("mode", "inactive"); app.map.fitBounds(c.fullBounds, {duration:500})'/>
    </body>
    <script src='../credentials.js'></script>

    <script src='src/map.js'></script>
    <script src="https://unpkg.com/cheap-ruler@3.0.1/cheap-ruler.min.js"></script>
    <script src="src/constants.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src='src/modal.js'></script>
    <script>

        mapboxgl.accessToken = config.token;

        const app = {

            init: () => {
                console.log('init');
                const {FontLoader, Shape, ShapeGeometry} = THREE;

                app.setState('buses')
                setInterval(()=>app.setState('buses'), 5000)


                // build marker primitive and load font
                const loader = new FontLoader();

                loader.load( 'src/Open Sans_Regular.json', font => {

                    c.font = font;
                    app.setState('initFont', true);

                } );

                const x = 0, y = 0;

                const markerShape = new Shape();
                markerShape.arc(0, 0, 1, Math.PI/2, 0, false);
                markerShape.lineTo(x+1, y+1);

                c.geometry.bus = new ShapeGeometry( markerShape );
                c.geometry.bus.matrixAutoUpdate = false;

                modal.trendView.update();
                modal.init();
            },


            ruler: new CheapRuler(s.center[1], 'feet'),

            getPrediction: (route, stop, cb) => {
                const url = `stopcodes/1${stop}/predictions`;

                app.utils.load(url, (r)=>{
                    const routeMatch = r.find(prediction=>prediction.route.id===route);
                    const predictions = routeMatch.values.map(v=>({seconds:(v.timestamp-Date.now())/1000, occupancy:v.occupancyDescription}))
                    cb(predictions || undefined);
                })

            },

            format: {

                time: (seconds) => {
                    let prediction;
                    if (!seconds) prediction = 'no current prediction'
                    else if (seconds>180) return `${Math.round(seconds/60)} minutes`
                    else if (seconds>60) {
                        const [minutes, secondRemainder] = [Math.floor(seconds/60), Math.round(seconds%60)];
                        return `${minutes}:${secondRemainder<10 ? 0 :''}${secondRemainder}`
                    }
                    else if (seconds>5) return `${Math.round(seconds)} seconds`
                    else return `approaching now`
                },

                distance: (feet) => {
                    return feet > 999 ? `${(feet/5280).toFixed(2)} mi`:`${feet.toFixed(0)} ft`;
                },

                occupancyString(raw) {
                    return raw.toLowerCase().replace('room ', '')
                },

                speed(kph) {
                    return kph ? 'moving at ' +Math.round(kph*0.621371) +' mph' : 'currently stopped'
                },
                
                graphYAxisExtent(raw, increment) {
                    increment = increment || 5000;
                    return Math.sign(raw) * Math.ceil(Math.abs(raw)/increment) * increment;
                },

                dirName(raw) {
                    if (!raw) return ''

                    // abbreviate
                    let formatted = raw
                        .replace(' from', ', from')
                        .replace('+', '&')
                        .replace(/Avenue/g, '')
                        .replace(/Street/g, '')

                    // remove if too long
                    if (formatted.length>20) formatted = formatted
                        .replace(' Ave', '')
                        .replace(' St ', '')
                    return formatted
                },

                _vehicleType(raw) {
                    const [type, code] = raw.split('_');

                    switch (type) {

                        case 'LRV': return 'Light Rail';
                        case 'Motor Coach': return 'Bus';
                        case 'Electric Trolley': return 'Trolley';
                        case 'Historic Street Car': return 'Streetcar';
                        default: return type
                    }
                },

                trendPopulation(raw) {
                    return Math.round(raw)
                },
                
                // for an array of stops, format intersection labels such that the repeating street comes second
                sameStreetSecond(array, mapFn, outputFn) {

                    let previousStop = null;
                    let nameArray = array.map(mapFn);
                    let conjunctionString = ' & ';
                    
                    const formattedArray = nameArray.map(name=>{

                        if (name.includes(conjunctionString)) {

                            const split = name.split(conjunctionString);
                            if (previousStop?.includes(split[0])) {
                                previousStop = name;
                                return split.reverse().join(conjunctionString);
                            }

                            else {
                                previousStop = name;
                                return name
                            }
                        }

                        else {
                            previousStop = null;
                            return name
                        }
                    })

                    return array.map((d,i)=>outputFn(d, formattedArray[i]))
                }

            },

            setState: (key, value) => {
                
                if (key === 'buses'){
                    const initialLoad = !s.buses;

                    app.utils.load('vehicles', (resp) => {

                        if (resp.length === 0) return
                        console.log('poll');
                        const {requestsInFlight, mode, debug} = s;
                        const {map, utils} = app;

                        s.lastPollTime = Date.now();
                        if (debug) resp = resp.slice(0,12)

                        const buses = resp
                            .filter(item =>item.dir?.id)
                        
                        buses
                            .forEach(line=>{
                                if (!c.routeData[line.route.id]) {
                                    c.routeData[line.route.id] = 'pending'
                                    fetchRouteData(line.route.id)
                                }
                            })


                        s.buses = buses
                            .map(item => {
                                const {dir:{id}} = item;
                                item.direction = utils.getDirection(id)
                                return item
                            });

                        
                        app.updateModalBar();

                        if (initialLoad) {
                            if (map.loaded()) setupMap()
                            else map.on('load', () => setupMap())
                        }

                        else s.animatingBuses = true;

                        s.customLayer.updateBuses();

                        const {routeView, systemView} = modal;
                        if (mode==='focus') routeView.updateBuses();
                        if (!requestsInFlight) systemView.updateRoutes();
                        })

                }

                if (key === 'activeRoute'){
                    s.activeBus = value;
                    const {route, direction, dir, vehiclePosition:{pathTag}} = value;
                    var newRoute = value ? [route.id, direction, dir.id, pathTag] : false
                    s.activeRoute = newRoute;
                    if (s.mode==='focus') {
                        modal.routeView.updateStops();
                        s.customLayer.setActiveRoute();
                    };
                        
                    updateRoute();
                }

                // inactive, active, focus modes
                else if (key === 'mode') {
                    const {mode, customLayer:{restoreBusMarkerColors}} = s;

                    if ([mode,value].includes('focus')) modal.element.scrollTop = 0;

                    s.mode = value;
                    console.warn(key, value)
                    document.querySelector('body')
                        .setAttribute('mode', value)

                        // apply map styling for current mode
                    c.style[value].forEach(style => {
                        app.map.setPaintProperty(...style)
                    })

                    if (value === 'inactive') restoreBusMarkerColors()
                    
                }


                else if (key.includes('init')) {

                    s[key] = value;

                    if (s.initScene === s.initFont === true) {

                        document.querySelector('#loader').style.opacity = 0

                        app.map
                            .on('mousemove', (e)=>{app.on.mouseMove(e)} )
                            .on('click', s.customLayer.onClick)
                            .on('zoom', app.on.zoom) 
                            .on('zoom', app.on.zoomEnd) 

                        }

                }
            },

            map: new mapboxgl.Map({
                container: 'map', // container id
                antialiased:true,

                style: 'mapbox://styles/peterqliu/clwh14gga00b001rbfwr02chk',
                center: s.center, // starting position
                // minZoom: 12,
                zoom: s.zoom // starting zoom
            }),

            popup: new mapboxgl.Popup({ 
                closeButton: false, 
                offset:25, 
                maxWidth:400 
            }),

            clearPopup: () => {
                app.popup.remove()
            },
            
            utils: {

                degreeify: radians =>{
                    radians = radians || 0;
                    return radians * 360/(Math.PI*2)
                },

                radify: deg => 2*Math.PI * deg/360,

                load: (queryString, cb) => {
                    const url = 'https://webservices.umoiq.com/api/pub/v1/agencies/sfmta-cis/';
                    const token = '?key=0be8ebd0284ce712a63f29dcaf7798c4';
                    s.requestsInFlight++;
                    return fetch([url, queryString, token].join(''))
                        .then(response => response.json())
                        .then(data=> {
                            s.requestsInFlight--
                            cb(data)
                        })
                },

                getDirection: str => {
                    var output = str.includes('_0_') ? 'OB' : 'IB'
                    return output
                },
                
                projectToScene: lngLat => {

                    const lng = lngLat.lng;

                    const xMercatorDelta = (lngLat[0]-s.center[0])/360;
                    const yMercatorDelta = 0.5 - 0.5 * Math.log(Math.tan(Math.PI * (1/4 + lngLat[1]/360)))/Math.PI - c.sceneTranslate.y

                    return new THREE.Vector3(xMercatorDelta, yMercatorDelta, Math.random()/10000000)
                },


                getCurrent: function(ms, interval, rewindDay) {
                    
                    // Create a new Date object representing the current date and time
                    const now = new Date(ms||Date.now());

                    if (rewindDay) now.setDate(now.getDate() - rewindDay);
                    
                    // Format the date using the Intl.DateTimeFormat object with the specified time zone
                    const options = { ...interval, hour12: false, timeZone: 'America/Los_Angeles' };
                    const formatter = new Intl.DateTimeFormat('en-US', options);

                    // Extract the hour from the formatted date string
                    const formattedDate = formatter.format(now);

                    return formattedDate;
                },

                derivative: function(array){

                    const deltas = array.map((r,rI)=>{
                        const frame = [-1, 1].map(n=>array[rI+n])
                            .filter(d=>d!==undefined);

                        const delta = frame[frame.length-1] - frame[0];
                        return delta/frame.length;

                    })

                    return deltas
                }
            },

            on: {

                mouseMove: e => {

                    const cL = s.customLayer;
                    const {customLayer} = s;
                    const {raycaster, highlightMarker, highlightStop} = customLayer;
                    const {Vector3, Matrix4} = THREE;
                    const mouse = new Vector3(
                        ( e.point.x / window.innerWidth ) * 2 - 1,
                        - ( e.point.y / window.innerHeight ) * 2 + 1,
                        1
                    )

                    const camInverseProjection = new Matrix4().getInverse(cL.camera.projectionMatrix);
                    const cameraPosition = new Vector3().applyMatrix4(camInverseProjection);
                    const mousePosition = mouse.applyMatrix4(camInverseProjection);
                    const viewDirection = mousePosition.clone().sub(cameraPosition).normalize();        

                    raycaster.set(cameraPosition, viewDirection)
                    const [intersect] = cL.raycaster.intersectObjects( s.mesh.markers);
                    highlightMarker(intersect ? intersect.object : undefined)
                
                    if (s.mode === 'focus' && !intersect) {
                        const hoveredStop = app.map
                            .queryRenderedFeatures(e.point, {layers:['stops']})[0];

                        highlightStop(hoveredStop)
                        if (!hoveredStop) app.popup.remove()

                    }
                    
                },

                zoom: () =>{
                    const z = app.map.getZoom();
                    const {labelZoomThreshold} = c;
                    const shouldShowLabels = z >= labelZoomThreshold;
                    
                    if (shouldShowLabels !== s.showLabels) {
                        console.log('changing')
                        const scale = shouldShowLabels ? 1 : 0.000001;
                        s.mesh.labels.forEach(label => label.scale.set(scale, scale, scale));
                        s.showLabels = shouldShowLabels;
                    }

                    c.material.OB.uniforms.highZoomSizeAttenuation.value = shouldShowLabels ? Math.pow(0.5, z-c.labelZoomThreshold) : 1;
                },

                zoomEnd: ()=>{
                    s.mesh.markers.forEach(m=>{
                        m.geometry.boundingSphere.radius = 1.4142135623730951*s.highZoomSizeAttenuation.value
                    })
                }
            },

            updateModalBar: () => {

                const IBCount = s.buses.filter(bus=>bus.direction === 'IB').length
                document.querySelector('#ob').innerHTML = s.buses.length - IBCount;
                document.querySelector('#ib').innerHTML = IBCount;

                document.querySelector('.bar div').style.width = 100 * IBCount / s.buses.length + '%';
            },

            updateModalRouteFocus: (stops) => {

                d3.select('#routeFocus .title')
                    .text(c.routeData[s.activeRoute[0]].title)

            }
        }

        app.init();
    </script>



    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,300' rel='stylesheet' type='text/css'>
    <script src='src/customlayer.js'></script>
    <script type="module" src="https://esm.town/v/peterqliu/browserify"></script>  

</head>

</html>