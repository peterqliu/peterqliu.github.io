
<html>
<head>
    <meta charset='utf-8' />
    <title>allthebuses</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='turf.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/94/three.min.js'></script>

    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.6.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.54.0/mapbox-gl.css' rel='stylesheet' />
    <style>

        body { margin:0; padding:0; font-family: 'Open Sans', Verdana, sans-serif;}
        #map, #overlay { position:absolute; top:0; bottom:0; width:100%; background:#B8C8D3;}
        /*#controls { position:absolute; top:0; left:0; }*/

        #back {
            z-index: 99;
            opacity:0.8;
            margin:1%;
            cursor:pointer;
            display:none;
            transition:transform 0.1s;
            transform-origin: center;
        }

        #back:hover {
            transform:scale(1.25);
        }
        canvas {
            cursor:auto;
        }
        .mapboxgl-map {
            font-family: inherit
        }

        .mapboxgl-popup-content {
            padding:20px;
            font-size:1.25em;
            border-radius: 5px;   
            color:#999;
            box-shadow: 0 2px 8px rgba(186, 180, 157, 1);
            pointer-events: none;
        }

        .title {
            font-weight:100;
            font-size:1.5em;
            color:#666;
            line-height: 1.5em;
        }

        .IB .highlight {
            color: rgba(170, 51, 69, 1);
        }        

        .OB .highlight {
            color: rgba(65, 166, 178, 1);
        }

        #loader {
            z-index: 99;
            display:none;
        }

        .blurred + #map{
            filter:blur(100px);
        }

        #loader:before {
            /*content: 'Fetching buses...';*/
        }

        #spinner {
            z-index: 99;
            width:10vh;
            height:10vh;
            margin-left:50vw;
            margin-top:50vh;
            background: #aa3345;
            transform-origin: center;
            animation-duration: 1.2s;
            animation-iteration-count: infinite;
            transform-origin: center;
            fill-opacity:0.8;
            border-radius: 50%;
            border-top-right-radius: 0%;
            position:absolute;
            animation-name: spinner;

        }

        @-webkit-keyframes spinner {
            0% {
                transform: translateX(-50%) translateY(-50%) rotate(45deg);
            }

            100% {
                transform: translateX(-50%) translateY(-50%) rotate(405deg) ;
            }
        }
    </style>
    <body>
        <div id='loader' class='blurred'>
            <!-- <div id='spinner' style='transform:rotateY(180deg); background:blue'></div> -->
            <div id='spinner' ></div>
            <div id='blurFilter'></div>

        </div>
        <div id='map'></div>
        <img src='zoomout.svg'id='back' onclick='app.setState("mode", "inactive"); app.map.easeTo(s)'/>
    </body>
    <script>

        mapboxgl.accessToken = 'pk.eyJ1IjoicGV0ZXJxbGl1IiwiYSI6ImNqdHE0cXByZDAzaWY0NHBldG9yd3Jld28ifQ.8dISItctShjFnmnVeAgW2A';

        var s = {
            mode: 'inactive',
            showLabels: false,
            center: [-122.437, 37.782],
            zoom: 13,
            pitch:0,
            activeRoute: false,
            routeDrawStart: Date.now(),

            highlightedBus: {
                uuid: null, 
                routeId: null,
                startTime: null,
                markerObj: null
            },

            map: {
                popup: new mapboxgl.Popup({ 
                    closeButton: false, 
                    offset:25, 
                    maxWidth:'none' 
                })

            }
        }

        var c = {
            labelZoomThreshold:14,
            animationDuration: 500,
            markerScale: 0.000002,
            emptyGeojson: {type:"FeatureCollection",features:[]},
            color: {
                'IB':'rgba(170, 51, 69, 1)',
                'OB': 'rgba(65, 166, 178, 1)',
                'weak':'#BAB49D'
            },
            routeData:{

            },
            customLayer: {

                id: '3d-model',
                type: 'custom',
                renderingMode: '3d',
                onAdd: (map, gl) => init(gl),

                render: (gl, matrix) => {

                    var m = new THREE.Matrix4().fromArray(matrix);
                    var l = new THREE.Matrix4()
                        .makeTranslation(
                            c.sceneTranslate.x,
                            c.sceneTranslate.y,
                            c.sceneTranslate.z
                        )

                    s.customLayer.camera.projectionMatrix = m.multiply(l);
                    if (s.animatingBuses) s.customLayer.animateBus();
                    s.customLayer.renderer.render(s.customLayer.scene, s.customLayer.camera);
                    app.map.triggerRepaint();

                }
            },
            material: {
                inactive: new THREE.MeshBasicMaterial( { 
                    color: 0xBAB49D, 
                    opacity:0.75, 
                    transparent:true, 
                    side: THREE.DoubleSide,
                    // depthWrite:false  
                }),
                IB: new THREE.MeshBasicMaterial( { 
                    color: 0xaa3345,            
                    opacity:0.75, 
                    transparent:true,
                    side: THREE.DoubleSide,
                    // depthWrite:false  
                } ),
                OB: new THREE.MeshBasicMaterial( { 
                    color: 0x41a6b2,            
                    opacity:0.75, 
                    transparent:true,
                    side: THREE.DoubleSide,
                    // depthWrite:false  
                } ),

                text: new THREE.MeshBasicMaterial( { 
                    color: 0xfffef9, 
                    side: THREE.BackSide,
                    // transparent:true,
                    opacity:0.25,
                    depthWrite:false 
                } )
            },

            geometry: {
                bus: null
            } 
        }

        c.style = {
            focus:[
                ['route', 'line-width', {stops:[[12,1], [22,20]]}],
                ['stops', 'circle-stroke-width', {stops:[[12,1], [22,20]]}],
                ['stops', 'circle-radius', {stops:[[12,1], [22,20]]}],
                // ['buses', 'circle-color', c.color.weak],
                ['bus_labels', 'text-opacity', 1]
            ],
            active:[
                ['route', 'line-width', {stops:[[12,1], [22,20]]}],
                ['stops', 'circle-stroke-width', {stops:[[12, 1], [22,20]]}],
                ['stops', 'circle-radius', 0],
                // ['buses', 'circle-color', c.color.weak],
                ['bus_labels', 'text-opacity', 0]
            ],
            inactive:[
                ['route', 'line-width', 0],
                ['stops', 'circle-stroke-width', 0],
                ['stops', 'circle-radius', 0],
                ['buses', 'circle-color', {
                    'property': 'direction',
                    'type':'categorical',
                    'stops':[['IB', c.color.IB], ['OB', c.color.OB]]
                }],
                ['bus_labels', 'text-opacity', 0]
            ]
        }

        const app = {

            getPrediction: (route, stop, cb) => {
                const url = `http://restbus.info/api/agencies/sf-muni/routes/${route}/stops/${stop}/predictions`;

                d3.json(url, (e,r)=>{
                    if (e) return
                    cb(r[0] ? r[0].values[0] : undefined);
                })

            },

            setState: (key, value) => {

                if (key === 'activeRoute'){

                    var newRoute = value ? [value.routeId,value.direction,value.directionId] : false

                    //if already highlighting
                    if (s.activeRoute){

                        if (newRoute){
                            if (newRoute !== s.activeRoute) s.activeRoute = newRoute
                        }

                        else s.activeRoute = newRoute
                    }

                    //if no previous highlight
                    else if (newRoute) s.activeRoute = newRoute

                    
                    // if no new highlight
                    else {}

                    updateRoute();
                }

                else if (key === 'mode') {

                    s.mode = value;
                    c.style[value].forEach(style => {
                        app.map.setPaintProperty(style[0], style[1], style[2])
                    })

                    document.querySelector('#back').style.display = value === 'focus' ? 'block' : 'none'

                    if (value === 'inactive') s.customLayer.restoreBusMarkerColors()

                }
            },

            map: new mapboxgl.Map({
                container: 'map', // container id
                // antialiased:true,
                style: 'mapbox://styles/peterqliu/cjnnukhkb08fu2so0ywo37ibj',
                center: s.center, // starting position
                // minZoom: 12,
                zoom: s.zoom // starting zoom
            }),

            utils: {

                degreeify: radians =>{
                    radians = radians || 0;
                    return radians * 360/(Math.PI*2)
                },

                radify: deg => 2*Math.PI * deg/360,

                load: (url, cb) => {
                    return fetch(url)
                        .then((response) => {
                             cb(response.json());
                        })
                },

                getDirection: str => {
                    var output = str.includes('_I_') ? 'IB' : 'OB'
                    return output
                },
                
                projectToScene: lngLat => {

                    const lng = lngLat.lng;

                    const xMercatorDelta = (lngLat[0]-s.center[0])/360;
                    const yMercatorDelta = 0.5 - 0.5 * Math.log(Math.tan(Math.PI * (1/4 + lngLat[1]/360)))/Math.PI - c.sceneTranslate.y

                    return new THREE.Vector3(xMercatorDelta, yMercatorDelta, Math.random()/10000000)
                }
            }
        }

    </script>



    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,300' rel='stylesheet' type='text/css'>
    <script src="d3.js"></script>
    <script src='map.js'></script>
    <script src='customlayer.js'></script>

    <!-- <script src='3.js'></script> -->
</head>

</html>